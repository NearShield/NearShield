#!/bin/bash
set -e  # Exit on any error

echo "ðŸ›¡ï¸ Installing NEARShield â€“ Complete Setup"

# 1. Clone repository (if not already in it)
if [ ! -d "NearShield" ]; then
  git clone https://github.com/NearShield/NearShield.git
  cd NearShield
else
  cd NearShield
  git pull
fi

# 2. Install Rust + wasm32 target
echo "ðŸ“¦ Installing Rust..."
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
source "$HOME/.cargo/env"
rustup target add wasm32-unknown-unknown

# 3. Install NEAR CLI
echo "ðŸ”§ Installing NEAR CLI..."
npm install -g near-cli

# 4. Install frontend dependencies
echo "ðŸ“¦ Setting up frontend..."
cd frontend/near-shield-app

# Use legacy peer deps to avoid near-api-js conflict
npm install --legacy-peer-deps

# Downgrade near-api-js to version compatible with wallet selector
npm install near-api-js@2.1.4 --save --legacy-peer-deps

# 5. Create .env.local (no web3.storage token needed)
echo "ðŸ” Creating environment file..."
cat > .env.local << 'EOF'
NEXT_PUBLIC_NEAR_NETWORK=testnet
NEXT_PUBLIC_CONTRACT_ID=nearshield.testnet
NEXT_PUBLIC_IPFS_GATEWAY=https://ipfs.io/ipfs/
EOF

# 6. Build smart contract
echo "âš™ï¸ Building NEARShield contract..."
cd ../../contracts/nearshield
cargo build --target wasm32-unknown-unknown --release

# 7. Return to frontend and run dev server
cd ../../frontend/near-shield-app
echo "âœ… Setup complete! Starting development server..."
npm run dev
